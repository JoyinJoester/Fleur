# 本地优先架构重构实现计划

## 阶段 1：同步队列基础设施

- [x] 1. 创建同步队列数据模型和 DAO





  - 创建 `SyncOperation` 实体类，包含操作类型、邮件 ID、时间戳、重试计数等字段
  - 创建 `OperationType` 枚举，定义所有支持的操作类型
  - 创建 `SyncQueueDao` 接口，提供队列的 CRUD 操作
  - 在 `FleurDatabase` 中注册 `SyncOperation` 实体
  - _需求: 1.3, 3.1, 3.2_

- [ ] 2. 实现 SyncQueueManager 核心逻辑
  - 创建 `SyncQueueManager` 类，注入必要的依赖
  - 实现 `enqueue()` 方法，添加操作到队列
  - 实现 `processSyncQueue()` 方法，处理队列中的操作
  - 实现 `getPendingCount()` 方法，获取待同步数量
  - 实现指数退避重试逻辑
  - _需求: 3.2, 3.3, 3.4, 5.2_

- [ ] 3. 创建后台同步 Worker
  - 创建 `SyncWorker` 类，继承 `CoroutineWorker`
  - 实现 `doWork()` 方法，调用 `SyncQueueManager.processSyncQueue()`
  - 配置 WorkManager 约束条件（网络、电量等）
  - 设置定期同步任务（默认 15 分钟）
  - _需求: 3.2, 6.3_

- [ ] 4. 添加 WebDAV 配置检查工具
  - 在 `PreferencesRepository` 中添加 WebDAV 配置字段
  - 创建 `isWebDAVEnabled()` 辅助方法
  - 实现配置验证逻辑
  - _需求: 2.1, 2.2_

## 阶段 2：EmailRepository 本地优先重构

- [ ] 5. 重构 markEmailsAsRead 方法
  - 修改方法逻辑：先更新本地数据库
  - 本地更新成功后立即返回成功结果
  - 如果 WebDAV 已启用，添加操作到同步队列
  - 移除对 WebDAV 错误的直接处理
  - _需求: 1.1, 1.2, 1.3, 2.3_

- [ ] 6. 重构 archiveEmail 和 archiveMultiple 方法
  - 采用本地优先策略
  - 集成同步队列
  - 确保批量操作的原子性
  - _需求: 1.1, 1.2, 1.3_

- [ ] 7. 重构 deleteEmail 和 deleteMultiple 方法
  - 采用本地优先策略
  - 集成同步队列
  - 处理级联删除（附件等）
  - _需求: 1.1, 1.2, 1.3_

- [ ] 8. 重构 toggleStar 方法
  - 采用本地优先策略
  - 集成同步队列
  - _需求: 1.1, 1.2, 1.3_

- [ ] 9. 重构 moveToFolder 方法
  - 采用本地优先策略
  - 集成同步队列
  - _需求: 1.1, 1.2, 1.3_

- [ ] 10. 更新 syncEmails 方法
  - 改为从 WebDAV 拉取数据到本地
  - 实现冲突解决逻辑（最后写入获胜）
  - 使用时间戳比较本地和远程数据
  - _需求: 4.1, 4.2, 4.3, 4.4_

## 阶段 3：ViewModel 层优化

- [ ] 11. 优化 InboxViewModel 的状态管理
  - 确保 `allEmails` 和 `emails` 同步更新
  - 移除对 WebDAV 错误的特殊处理
  - 简化错误处理逻辑
  - _需求: 1.1, 6.1_

- [ ] 12. 移除 observeBackgroundSync 的自动刷新
  - 修改 `observeBackgroundSync()` 方法
  - 移除同步完成后的 `loadEmails(reset = true)` 调用
  - 改为静默更新已加载的邮件状态
  - _需求: 6.2, 6.5_

- [ ] 13. 添加同步状态观察
  - 在 `InboxUiState` 中添加 `pendingSyncCount` 字段
  - 观察 `SyncQueueManager.getPendingCount()`
  - 在 UI 中显示待同步数量
  - _需求: 3.5_

- [ ] 14. 优化其他 ViewModel
  - 更新 `EmailDetailViewModel`
  - 更新 `FolderViewModel`
  - 确保所有 ViewModel 使用本地优先策略
  - _需求: 1.1, 6.1_

## 阶段 4：UI 层更新

- [ ] 15. 添加同步状态指示器
  - 在收件箱顶部显示待同步数量
  - 添加同步进度动画
  - 显示最后同步时间
  - _需求: 3.5, 2.5_

- [ ] 16. 更新设置界面
  - 添加 WebDAV 启用/禁用开关
  - 添加 WebDAV 配置表单（URL、用户名、密码）
  - 添加手动同步按钮
  - 显示同步状态和错误信息
  - _需求: 2.1, 2.2, 2.4, 2.5_

- [ ] 17. 添加同步错误通知
  - 当同步失败时显示通知
  - 提供重试选项
  - 显示错误详情
  - _需求: 5.1, 5.2_

- [ ] 18. 优化离线体验
  - 在离线状态下隐藏同步相关 UI
  - 显示离线指示器
  - 确保所有操作在离线状态下正常工作
  - _需求: 1.4, 2.1_

## 阶段 5：测试和优化

- [ ]* 19. 编写单元测试
  - 测试 `SyncQueueManager` 的队列管理逻辑
  - 测试 `EmailRepositoryImpl` 的本地优先逻辑
  - 测试错误处理和重试机制
  - _需求: 所有需求_

- [ ]* 20. 编写集成测试
  - 测试本地数据库 + 同步队列的集成
  - 测试 WebDAV 同步的端到端流程
  - 测试网络状态变化的处理
  - _需求: 所有需求_

- [ ] 21. 性能优化
  - 实现批量同步逻辑
  - 添加同步限流机制
  - 优化数据库查询
  - _需求: 6.1, 6.2, 6.3_

- [ ] 22. 添加监控和日志
  - 记录所有同步操作日志
  - 添加性能指标收集
  - 实现错误追踪
  - _需求: 5.1, 5.3_

## 阶段 6：数据迁移和向后兼容

- [ ] 23. 实现数据迁移逻辑
  - 创建数据库迁移脚本
  - 保留现有邮件数据
  - 保留 WebDAV 配置
  - _需求: 7.1, 7.2, 7.3_

- [ ] 24. 添加迁移失败回滚机制
  - 实现迁移前备份
  - 实现迁移失败检测
  - 实现自动回滚逻辑
  - _需求: 7.4_

- [ ] 25. 记录迁移日志
  - 记录迁移开始和完成时间
  - 记录迁移的数据量
  - 记录迁移错误（如果有）
  - _需求: 7.5_

## 阶段 7：文档和发布

- [ ] 26. 更新技术文档
  - 更新架构文档
  - 更新 API 文档
  - 添加同步机制说明

- [ ] 27. 编写用户文档
  - 编写 WebDAV 配置指南
  - 编写同步功能说明
  - 编写常见问题解答

- [ ] 28. 准备发布
  - 完成所有测试
  - 进行性能测试
  - 准备发布说明
