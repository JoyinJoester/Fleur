# æœ¬åœ°ä¼˜å…ˆæ¶æ„è®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†å°† Fleur é‚®ä»¶åº”ç”¨é‡æ„ä¸ºæœ¬åœ°ä¼˜å…ˆæ¶æ„çš„è®¾è®¡æ–¹æ¡ˆã€‚æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šæ‰€æœ‰æ“ä½œç«‹å³åœ¨æœ¬åœ°ç”Ÿæ•ˆï¼ŒWebDAV åŒæ­¥ä½œä¸ºå¯é€‰çš„åå°ä»»åŠ¡å¼‚æ­¥æ‰§è¡Œã€‚

## æ¶æ„è®¾è®¡

### å½“å‰æ¶æ„é—®é¢˜

1. **è¿œç¨‹ä¾èµ–**ï¼š`EmailRepositoryImpl` ä¸­çš„æ“ä½œï¼ˆå¦‚ `markEmailsAsRead`ï¼‰å…ˆæ›´æ–° WebDAVï¼Œå†æ›´æ–°æœ¬åœ°æ•°æ®åº“
2. **åŒæ­¥é˜»å¡**ï¼šå¦‚æœ WebDAV è¯·æ±‚å¤±è´¥ï¼Œæœ¬åœ°æ•°æ®åº“ä¸ä¼šæ›´æ–°ï¼Œå¯¼è‡´ UI çŠ¶æ€ä¸ä¸€è‡´
3. **å¼ºåˆ¶ä¾èµ–**ï¼šå³ä½¿ç”¨æˆ·ä¸ä½¿ç”¨ WebDAVï¼Œä¹Ÿå¿…é¡»å¤„ç† WebDAV ç›¸å…³çš„é”™è¯¯

### æ–°æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         UI Layer                             â”‚
â”‚  (InboxViewModel, EmailDetailViewModel, etc.)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Domain Layer                            â”‚
â”‚  (Use Cases: MarkAsReadUseCase, ArchiveEmailUseCase, etc.)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Data Layer (Local-First)                  â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          EmailRepositoryImpl (æœ¬åœ°ä¼˜å…ˆ)               â”‚  â”‚
â”‚  â”‚                                                        â”‚  â”‚
â”‚  â”‚  1. ç«‹å³æ›´æ–°æœ¬åœ°æ•°æ®åº“ âœ“                              â”‚  â”‚
â”‚  â”‚  2. è¿”å›æˆåŠŸç»“æœç»™è°ƒç”¨è€… âœ“                            â”‚  â”‚
â”‚  â”‚  3. æ·»åŠ æ“ä½œåˆ°åŒæ­¥é˜Ÿåˆ—ï¼ˆå¦‚æœ WebDAV å·²å¯ç”¨ï¼‰         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              SyncQueueManager                         â”‚  â”‚
â”‚  â”‚                                                        â”‚  â”‚
â”‚  â”‚  - ç®¡ç†å¾…åŒæ­¥æ“ä½œé˜Ÿåˆ—                                 â”‚  â”‚
â”‚  â”‚  - åå°å¼‚æ­¥åŒæ­¥åˆ° WebDAV                             â”‚  â”‚
â”‚  â”‚  - å¤„ç†åŒæ­¥å¤±è´¥å’Œé‡è¯•                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚                   â”‚
                      â–¼                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Local Database   â”‚  â”‚  WebDAV Client   â”‚
         â”‚   (Room/SQLite)    â”‚  â”‚   (å¯é€‰)         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 1. SyncQueueManager

è´Ÿè´£ç®¡ç†å¾…åŒæ­¥æ“ä½œé˜Ÿåˆ—å’Œåå°åŒæ­¥é€»è¾‘ã€‚

```kotlin
class SyncQueueManager(
    private val syncQueueDao: SyncQueueDao,
    private val webdavClient: WebDAVClient,
    private val preferencesRepository: PreferencesRepository,
    private val networkMonitor: NetworkMonitor
) {
    // æ·»åŠ æ“ä½œåˆ°åŒæ­¥é˜Ÿåˆ—
    suspend fun enqueue(operation: SyncOperation)
    
    // å¤„ç†åŒæ­¥é˜Ÿåˆ—
    suspend fun processSyncQueue()
    
    // è·å–å¾…åŒæ­¥æ“ä½œæ•°é‡
    suspend fun getPendingCount(): Int
    
    // æ¸…ç©ºåŒæ­¥é˜Ÿåˆ—
    suspend fun clearQueue()
}
```

### 2. SyncOperation æ•°æ®æ¨¡å‹

```kotlin
@Entity(tableName = "sync_queue")
data class SyncOperation(
    @PrimaryKey(autoGenerate = true)
    val id: Long = 0,
    val operationType: OperationType,
    val emailId: String,
    val timestamp: Instant,
    val retryCount: Int = 0,
    val lastError: String? = null
)

enum class OperationType {
    MARK_READ,
    MARK_UNREAD,
    ARCHIVE,
    DELETE,
    STAR,
    UNSTAR,
    MOVE_TO_FOLDER
}
```

### 3. EmailRepositoryImpl é‡æ„

å°†æ‰€æœ‰æ“ä½œæ”¹ä¸ºæœ¬åœ°ä¼˜å…ˆï¼š

```kotlin
override suspend fun markEmailsAsRead(
    emailIds: List<String>, 
    isRead: Boolean
): Result<Unit> {
    return try {
        // 1. ç«‹å³æ›´æ–°æœ¬åœ°æ•°æ®åº“
        emailDao.markEmailsAsRead(emailIds, isRead)
        
        // 2. å¦‚æœ WebDAV å·²å¯ç”¨ï¼Œæ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—
        if (isWebDAVEnabled()) {
            emailIds.forEach { emailId ->
                syncQueueManager.enqueue(
                    SyncOperation(
                        operationType = if (isRead) OperationType.MARK_READ 
                                       else OperationType.MARK_UNREAD,
                        emailId = emailId,
                        timestamp = Clock.System.now()
                    )
                )
            }
        }
        
        // 3. ç«‹å³è¿”å›æˆåŠŸ
        Result.success(Unit)
    } catch (e: Exception) {
        Result.failure(FleurError.DatabaseError(e.message ?: "æœ¬åœ°æ›´æ–°å¤±è´¥"))
    }
}
```

### 4. WebDAV é…ç½®æ£€æŸ¥

```kotlin
private suspend fun isWebDAVEnabled(): Boolean {
    val preferences = preferencesRepository.getUserPreferences().first()
    return preferences.webdavEnabled && 
           preferences.webdavUrl.isNotBlank() &&
           preferences.webdavUsername.isNotBlank()
}
```

### 5. åå°åŒæ­¥ Worker

ä½¿ç”¨ WorkManager å®šæœŸå¤„ç†åŒæ­¥é˜Ÿåˆ—ï¼š

```kotlin
class SyncWorker(
    context: Context,
    params: WorkerParameters,
    private val syncQueueManager: SyncQueueManager
) : CoroutineWorker(context, params) {
    
    override suspend fun doWork(): Result {
        return try {
            syncQueueManager.processSyncQueue()
            Result.success()
        } catch (e: Exception) {
            if (runAttemptCount < 3) {
                Result.retry()
            } else {
                Result.failure()
            }
        }
    }
}
```

## æ•°æ®æµè®¾è®¡

### ç”¨æˆ·æ“ä½œæµç¨‹ï¼ˆæ ‡è®°ä¸ºæœªè¯»ç¤ºä¾‹ï¼‰

1. **ç”¨æˆ·ç‚¹å‡»"æ ‡ä¸ºæœªè¯»"æŒ‰é’®**
   - UI è°ƒç”¨ `viewModel.markSelectedAsRead(false)`

2. **ViewModel å¤„ç†**
   - è°ƒç”¨ `markAsReadUseCase.markMultiple(selectedIds, false)`
   - ä¹è§‚æ›´æ–° UI çŠ¶æ€ï¼ˆç«‹å³æ˜¾ç¤ºä¸ºæœªè¯»ï¼‰

3. **Use Case æ‰§è¡Œ**
   - è°ƒç”¨ `emailRepository.markEmailsAsRead(emailIds, false)`

4. **Repository å¤„ç†ï¼ˆæœ¬åœ°ä¼˜å…ˆï¼‰**
   - âœ… ç«‹å³æ›´æ–°æœ¬åœ°æ•°æ®åº“ï¼š`emailDao.markEmailsAsRead(emailIds, false)`
   - âœ… è¿”å› `Result.success(Unit)`
   - ğŸ”„ å¦‚æœ WebDAV å·²å¯ç”¨ï¼Œæ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—

5. **åå°åŒæ­¥ï¼ˆå¼‚æ­¥ï¼‰**
   - SyncWorker å®šæœŸæ£€æŸ¥åŒæ­¥é˜Ÿåˆ—
   - å¦‚æœç½‘ç»œå¯ç”¨ä¸” WebDAV å·²é…ç½®ï¼Œæ‰§è¡ŒåŒæ­¥
   - åŒæ­¥æˆåŠŸï¼šä»é˜Ÿåˆ—ä¸­ç§»é™¤æ“ä½œ
   - åŒæ­¥å¤±è´¥ï¼šå¢åŠ é‡è¯•è®¡æ•°ï¼Œä½¿ç”¨æŒ‡æ•°é€€é¿é‡è¯•

### åŒæ­¥é˜Ÿåˆ—å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SyncQueueManager.processSyncQueue()                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ æ£€æŸ¥ WebDAV æ˜¯å¦å¯ç”¨  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ è·å–å¾…åŒæ­¥æ“ä½œåˆ—è¡¨    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  æŒ‰æ—¶é—´æˆ³æ’åºæ“ä½œ     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  é€ä¸ªæ‰§è¡ŒåŒæ­¥æ“ä½œ     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚
         â–¼                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æˆåŠŸ  â”‚            â”‚  å¤±è´¥  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜            â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚                    â”‚
         â–¼                    â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ä»é˜Ÿåˆ—ä¸­ç§»é™¤ â”‚    â”‚ å¢åŠ é‡è¯•è®¡æ•° â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ è®°å½•é”™è¯¯ä¿¡æ¯ â”‚
                      â”‚ æŒ‡æ•°é€€é¿é‡è¯• â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é”™è¯¯å¤„ç†ç­–ç•¥

### 1. æœ¬åœ°æ•°æ®åº“é”™è¯¯

- **åœºæ™¯**ï¼šæœ¬åœ°æ•°æ®åº“æ›´æ–°å¤±è´¥ï¼ˆç£ç›˜ç©ºé—´ä¸è¶³ã€æ•°æ®åº“æŸåç­‰ï¼‰
- **å¤„ç†**ï¼š
  - è¿”å›å¤±è´¥ç»“æœç»™ UI
  - æ˜¾ç¤ºé”™è¯¯æç¤º
  - ä¸æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—

### 2. WebDAV åŒæ­¥å¤±è´¥

- **åœºæ™¯**ï¼šç½‘ç»œé”™è¯¯ã€æœåŠ¡å™¨é”™è¯¯ã€è®¤è¯å¤±è´¥ç­‰
- **å¤„ç†**ï¼š
  - æœ¬åœ°æ“ä½œå·²æˆåŠŸï¼Œä¸å½±å“ç”¨æˆ·ä½¿ç”¨
  - è®°å½•é”™è¯¯ä¿¡æ¯åˆ°åŒæ­¥é˜Ÿåˆ—
  - ä½¿ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥é‡è¯•ï¼ˆ1s, 2s, 4s, 8s, ...ï¼‰
  - è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°åï¼Œæ ‡è®°ä¸ºå¤±è´¥å¹¶é€šçŸ¥ç”¨æˆ·

### 3. å†²çªè§£å†³

- **åœºæ™¯**ï¼šæœ¬åœ°å’Œè¿œç¨‹æ•°æ®éƒ½æœ‰æ›´æ–°
- **å¤„ç†**ï¼š
  - ä½¿ç”¨"æœ€åå†™å…¥è·èƒœ"ï¼ˆLast-Write-Winsï¼‰ç­–ç•¥
  - æ¯”è¾ƒæ—¶é—´æˆ³ï¼Œä¿ç•™æœ€æ–°çš„æ•°æ®
  - è®°å½•å†²çªæ—¥å¿—ä»¥ä¾¿è°ƒè¯•

## æ€§èƒ½ä¼˜åŒ–

### 1. æ‰¹é‡åŒæ­¥

- å°†å¤šä¸ªç›¸åŒç±»å‹çš„æ“ä½œåˆå¹¶ä¸ºä¸€ä¸ªæ‰¹é‡è¯·æ±‚
- ä¾‹å¦‚ï¼š10 ä¸ª"æ ‡è®°å·²è¯»"æ“ä½œ â†’ 1 ä¸ªæ‰¹é‡è¯·æ±‚

### 2. å¢é‡åŒæ­¥

- åªåŒæ­¥è‡ªä¸Šæ¬¡åŒæ­¥ä»¥æ¥çš„å˜æ›´
- ä½¿ç”¨æ—¶é—´æˆ³è¿‡æ»¤å¾…åŒæ­¥æ“ä½œ

### 3. åå°é™æµ

- é™åˆ¶åŒæ­¥é¢‘ç‡ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
- ä½¿ç”¨ WorkManager çš„çº¦æŸæ¡ä»¶ï¼ˆç½‘ç»œã€ç”µé‡ç­‰ï¼‰

### 4. æ•°æ®å‹ç¼©

- å¯¹å¤§é‡æ•°æ®ä½¿ç”¨ GZIP å‹ç¼©
- å‡å°‘ç½‘ç»œä¼ è¾“é‡

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•

- `SyncQueueManager` çš„é˜Ÿåˆ—ç®¡ç†é€»è¾‘
- `EmailRepositoryImpl` çš„æœ¬åœ°ä¼˜å…ˆé€»è¾‘
- é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

### é›†æˆæµ‹è¯•

- æœ¬åœ°æ•°æ®åº“ + åŒæ­¥é˜Ÿåˆ—çš„é›†æˆ
- WebDAV åŒæ­¥çš„ç«¯åˆ°ç«¯æµ‹è¯•
- ç½‘ç»œçŠ¶æ€å˜åŒ–çš„å¤„ç†

### UI æµ‹è¯•

- ç¦»çº¿çŠ¶æ€ä¸‹çš„æ“ä½œæµç•…æ€§
- åŒæ­¥çŠ¶æ€çš„ UI æ˜¾ç¤º
- é”™è¯¯æç¤ºçš„æ­£ç¡®æ€§

## è¿ç§»è®¡åˆ’

### é˜¶æ®µ 1ï¼šæ·»åŠ åŒæ­¥é˜Ÿåˆ—åŸºç¡€è®¾æ–½

- åˆ›å»º `SyncOperation` å®ä½“å’Œ DAO
- å®ç° `SyncQueueManager`
- æ·»åŠ  `SyncWorker`

### é˜¶æ®µ 2ï¼šé‡æ„ EmailRepository

- ä¿®æ”¹æ‰€æœ‰æ“ä½œä¸ºæœ¬åœ°ä¼˜å…ˆ
- é›†æˆåŒæ­¥é˜Ÿåˆ—
- ä¿æŒå‘åå…¼å®¹

### é˜¶æ®µ 3ï¼šæ›´æ–° UI å±‚

- ç§»é™¤å¯¹ WebDAV é”™è¯¯çš„ç›´æ¥å¤„ç†
- æ·»åŠ åŒæ­¥çŠ¶æ€æ˜¾ç¤º
- ä¼˜åŒ–ä¹è§‚ UI æ›´æ–°

### é˜¶æ®µ 4ï¼šæµ‹è¯•å’Œä¼˜åŒ–

- å…¨é¢æµ‹è¯•å„ç§åœºæ™¯
- æ€§èƒ½ä¼˜åŒ–
- é”™è¯¯å¤„ç†å®Œå–„

## é…ç½®ç®¡ç†

### ç”¨æˆ·åå¥½è®¾ç½®

```kotlin
data class UserPreferences(
    // WebDAV é…ç½®
    val webdavEnabled: Boolean = false,
    val webdavUrl: String = "",
    val webdavUsername: String = "",
    val webdavPassword: String = "",
    
    // åŒæ­¥è®¾ç½®
    val autoSyncEnabled: Boolean = true,
    val syncOnWifiOnly: Boolean = true,
    val syncInterval: Duration = 15.minutes,
    
    // å…¶ä»–è®¾ç½®...
)
```

### åŒæ­¥çŠ¶æ€æ˜¾ç¤º

åœ¨è®¾ç½®ç•Œé¢æ˜¾ç¤ºï¼š
- WebDAV å¯ç”¨çŠ¶æ€
- æœ€ååŒæ­¥æ—¶é—´
- å¾…åŒæ­¥æ“ä½œæ•°é‡
- åŒæ­¥é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
- æ‰‹åŠ¨åŒæ­¥æŒ‰é’®

## å®‰å…¨è€ƒè™‘

### 1. æ•°æ®åŠ å¯†

- æœ¬åœ°æ•°æ®åº“ä½¿ç”¨ SQLCipher åŠ å¯†
- WebDAV å¯†ç ä½¿ç”¨ Android Keystore å­˜å‚¨

### 2. è®¤è¯

- WebDAV ä½¿ç”¨ Basic Auth æˆ– OAuth
- æ”¯æŒè‡ªç­¾åè¯ä¹¦ï¼ˆå¯é€‰ï¼‰

### 3. æ•°æ®å®Œæ•´æ€§

- ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- åŒæ­¥å‰éªŒè¯æ•°æ®å®Œæ•´æ€§

## ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—è®°å½•

- æ‰€æœ‰åŒæ­¥æ“ä½œè®°å½•æ—¥å¿—
- é”™è¯¯è¯¦æƒ…å’Œå †æ ˆè·Ÿè¸ª
- æ€§èƒ½æŒ‡æ ‡ï¼ˆåŒæ­¥è€—æ—¶ã€æ•°æ®é‡ç­‰ï¼‰

### ç›‘æ§æŒ‡æ ‡

- åŒæ­¥æˆåŠŸç‡
- å¹³å‡åŒæ­¥å»¶è¿Ÿ
- å¾…åŒæ­¥é˜Ÿåˆ—é•¿åº¦
- é”™è¯¯ç±»å‹åˆ†å¸ƒ
